version: "3.9"

# ============================================================
# GreenOps — Docker Compose (Production-Stable)
# ============================================================
# Key fixes:
#   - db healthcheck: server only starts after Postgres is ready
#   - migrate service: runs all migrations before server boots
#   - restart: unless-stopped on all long-lived services
#   - Only infrastructure secrets in ENV (no runtime config)
# ============================================================

services:

  # ── PostgreSQL ─────────────────────────────────────────────────────────────
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       greenops
      POSTGRES_USER:     greenops
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    volumes:
      - db_data:/var/lib/postgresql/data
    # No host port binding — DB is only needed inside the Docker network.
    # Avoids conflict with any PostgreSQL running on the host at port 5432.
    # To connect from the host for debugging: docker compose exec db psql -U greenops greenops
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U greenops -d greenops"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ── Migrations (run once, exit) ────────────────────────────────────────────
  migrate:
    image: postgres:15-alpine
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./migrations:/migrations:ro
    command: >
      sh -c "
        echo 'Running migrations...'
        for f in /migrations/*.sql; do
          echo \"Applying: $$f\"
          psql -h db -U greenops -d greenops -f $$f
        done
        echo 'Migrations complete.'
      "
    restart: "no"

  # ── GreenOps Server ────────────────────────────────────────────────────────
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      # ── Infrastructure only (runtime config lives in DB) ──────────────────
      DATABASE_URL:      postgresql://greenops:${POSTGRES_PASSWORD}@db:5432/greenops
      JWT_SECRET_KEY:    ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      FLASK_SECRET_KEY:  ${FLASK_SECRET_KEY:-${JWT_SECRET_KEY}}
      FLASK_ENV:         ${FLASK_ENV:-production}
      PORT:              ${PORT:-5000}
      # ── REMOVED: IDLE_THRESHOLD_SECONDS, IDLE_POWER_WATTS, etc. ──────────
      # These are now stored in the app_settings database table.
      # Change them via the Settings UI or API.
    ports:
      - "${PORT:-5000}:${PORT:-5000}"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${PORT:-5000}/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    volumes:
      - ./logs:/app/logs

  # ── Dashboard (optional: nginx static file server) ─────────────────────────
  dashboard:
    image: nginx:alpine
    restart: unless-stopped
    depends_on:
      - server
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  db_data:
    driver: local
